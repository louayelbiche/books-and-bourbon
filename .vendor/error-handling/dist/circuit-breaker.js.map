{"version":3,"sources":["../src/circuit-breaker.ts"],"sourcesContent":["/**\n * @runwell/error-handling â€” Circuit Breaker\n *\n * Protects external service calls from cascading failures.\n * States: CLOSED (normal) -> OPEN (failing) -> HALF_OPEN (testing recovery)\n * Logger is injectable via options (not hardcoded).\n */\n\nimport { CircuitOpenError } from \"./index.js\";\n\nexport type CircuitState = \"closed\" | \"open\" | \"half-open\";\n\nexport interface CircuitBreakerLogger {\n  debug?(message: string, meta?: Record<string, unknown>): void;\n  info?(message: string, meta?: Record<string, unknown>): void;\n  warn?(message: string, meta?: Record<string, unknown>): void;\n  error?(message: string, meta?: Record<string, unknown>): void;\n}\n\nexport interface CircuitBreakerOptions {\n  name: string;\n  failureThreshold: number;\n  resetTimeout: number;\n  halfOpenRequests: number;\n  onStateChange?: (\n    from: CircuitState,\n    to: CircuitState,\n    name: string\n  ) => void;\n  logger?: CircuitBreakerLogger;\n}\n\nexport interface CircuitStats {\n  name: string;\n  state: CircuitState;\n  failures: number;\n  successes: number;\n  lastFailure: Date | null;\n  lastSuccess: Date | null;\n  nextAttempt: Date | null;\n  totalRequests: number;\n  totalFailures: number;\n}\n\nconst defaultOptions: Omit<CircuitBreakerOptions, \"name\"> = {\n  failureThreshold: 5,\n  resetTimeout: 30000,\n  halfOpenRequests: 3,\n};\n\nexport class CircuitBreaker {\n  private state: CircuitState = \"closed\";\n  private failures = 0;\n  private successes = 0;\n  private lastFailure: Date | null = null;\n  private lastSuccess: Date | null = null;\n  private halfOpenAttempts = 0;\n  private totalRequests = 0;\n  private totalFailures = 0;\n\n  private readonly options: CircuitBreakerOptions;\n  private readonly log: CircuitBreakerLogger;\n\n  constructor(options: Partial<CircuitBreakerOptions> & { name: string }) {\n    this.options = { ...defaultOptions, ...options };\n    this.log = this.options.logger ?? {};\n  }\n\n  async execute<T>(\n    operation: () => Promise<T>,\n    fallback?: () => Promise<T>\n  ): Promise<T> {\n    this.totalRequests++;\n\n    if (this.state === \"open\") {\n      if (this.shouldAttemptReset()) {\n        this.transitionTo(\"half-open\");\n        this.halfOpenAttempts = 0;\n      } else {\n        if (fallback) {\n          this.log.debug?.(\n            `Circuit ${this.options.name}: using fallback (open)`\n          );\n          return fallback();\n        }\n        throw new CircuitOpenError(this.options.name);\n      }\n    }\n\n    if (\n      this.state === \"half-open\" &&\n      this.halfOpenAttempts >= this.options.halfOpenRequests\n    ) {\n      if (fallback) {\n        this.log.debug?.(\n          `Circuit ${this.options.name}: using fallback (half-open limit)`\n        );\n        return fallback();\n      }\n      throw new CircuitOpenError(this.options.name);\n    }\n\n    if (this.state === \"half-open\") {\n      this.halfOpenAttempts++;\n    }\n\n    try {\n      const result = await operation();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure(error);\n\n      if (this.state === \"open\" && fallback) {\n        this.log.debug?.(\n          `Circuit ${this.options.name}: using fallback after failure`\n        );\n        return fallback();\n      }\n\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.successes++;\n    this.lastSuccess = new Date();\n\n    if (this.state === \"half-open\") {\n      if (this.successes >= this.options.halfOpenRequests) {\n        this.reset();\n        this.log.info?.(\n          `Circuit ${this.options.name}: closed (recovered)`\n        );\n      }\n    } else {\n      this.failures = 0;\n    }\n  }\n\n  private onFailure(error: unknown): void {\n    this.failures++;\n    this.totalFailures++;\n    this.lastFailure = new Date();\n\n    this.log.warn?.(`Circuit ${this.options.name}: failure recorded`, {\n      failures: this.failures,\n      threshold: this.options.failureThreshold,\n      error: error instanceof Error ? error.message : String(error),\n    });\n\n    if (this.failures >= this.options.failureThreshold) {\n      this.transitionTo(\"open\");\n      this.log.error?.(\n        `Circuit ${this.options.name}: opened after ${this.failures} failures`\n      );\n    }\n  }\n\n  private shouldAttemptReset(): boolean {\n    if (!this.lastFailure) return false;\n    const elapsed = Date.now() - this.lastFailure.getTime();\n    return elapsed >= this.options.resetTimeout;\n  }\n\n  private transitionTo(newState: CircuitState): void {\n    if (this.state !== newState) {\n      const oldState = this.state;\n      this.state = newState;\n      this.options.onStateChange?.(oldState, newState, this.options.name);\n    }\n  }\n\n  private reset(): void {\n    this.transitionTo(\"closed\");\n    this.failures = 0;\n    this.successes = 0;\n    this.halfOpenAttempts = 0;\n  }\n\n  forceOpen(): void {\n    this.transitionTo(\"open\");\n    this.lastFailure = new Date();\n    this.log.warn?.(`Circuit ${this.options.name}: forced open`);\n  }\n\n  forceClose(): void {\n    this.reset();\n    this.log.info?.(`Circuit ${this.options.name}: forced closed`);\n  }\n\n  getStats(): CircuitStats {\n    return {\n      name: this.options.name,\n      state: this.state,\n      failures: this.failures,\n      successes: this.successes,\n      lastFailure: this.lastFailure,\n      lastSuccess: this.lastSuccess,\n      nextAttempt: this.lastFailure\n        ? new Date(this.lastFailure.getTime() + this.options.resetTimeout)\n        : null,\n      totalRequests: this.totalRequests,\n      totalFailures: this.totalFailures,\n    };\n  }\n\n  isOpen(): boolean {\n    return this.state === \"open\";\n  }\n\n  isClosed(): boolean {\n    return this.state === \"closed\";\n  }\n}\n\n/**\n * Create a new circuit breaker with custom options.\n */\nexport function createCircuitBreaker(\n  options: Partial<CircuitBreakerOptions> & { name: string }\n): CircuitBreaker {\n  return new CircuitBreaker(options);\n}\n"],"mappings":"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","names":[]}