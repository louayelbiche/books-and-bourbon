{"version":3,"sources":["../src/response.ts"],"sourcesContent":["/**\n * @runwell/error-handling — Response Helpers\n *\n * Standardized API response formatters for Next.js API routes.\n * Logger is injectable via options (not hardcoded).\n */\n\nimport { NextResponse } from \"next/server\";\nimport { AppError, RateLimitError, isAppError } from \"./index.js\";\n\nexport interface ResponseMeta {\n  timestamp: string;\n  correlationId?: string;\n  [key: string]: unknown;\n}\n\nexport interface ApiSuccessResponse<T> {\n  success: true;\n  data: T;\n  meta: ResponseMeta;\n}\n\nexport interface ApiErrorResponse {\n  success: false;\n  error: {\n    code: string;\n    message: string;\n    correlationId?: string;\n    details?: Record<string, unknown>;\n    retryAfter?: number;\n  };\n}\n\nexport type ApiResponse<T> = ApiSuccessResponse<T> | ApiErrorResponse;\n\nexport interface Logger {\n  error(message: string, meta?: Record<string, unknown>): void;\n  warn?(message: string, meta?: Record<string, unknown>): void;\n}\n\nexport interface SuccessResponseOptions {\n  correlationId?: string;\n  meta?: Record<string, unknown>;\n  status?: number;\n}\n\nexport interface ErrorResponseOptions {\n  correlationId?: string;\n  logger?: Logger;\n}\n\n/**\n * Create a standardized success response.\n */\nexport function successResponse<T>(\n  data: T,\n  options?: SuccessResponseOptions\n): NextResponse<ApiSuccessResponse<T>> {\n  const response: ApiSuccessResponse<T> = {\n    success: true,\n    data,\n    meta: {\n      timestamp: new Date().toISOString(),\n      ...(options?.correlationId && { correlationId: options.correlationId }),\n      ...(options?.meta || {}),\n    },\n  };\n\n  return NextResponse.json(response, { status: options?.status ?? 200 });\n}\n\n/**\n * Create a standardized error response.\n * Handles both AppError instances and unknown errors.\n *\n * Supports two call signatures for backward compatibility:\n *   errorResponse(error, 'correlation-id')\n *   errorResponse(error, { correlationId, logger })\n */\nexport function errorResponse(\n  error: unknown,\n  optionsOrCorrelationId?: string | ErrorResponseOptions\n): NextResponse<ApiErrorResponse> {\n  const correlationId =\n    typeof optionsOrCorrelationId === \"string\"\n      ? optionsOrCorrelationId\n      : optionsOrCorrelationId?.correlationId;\n  const logger =\n    typeof optionsOrCorrelationId === \"object\"\n      ? optionsOrCorrelationId?.logger\n      : undefined;\n\n  if (isAppError(error)) {\n    if (correlationId) {\n      (error as { correlationId?: string }).correlationId = correlationId;\n    }\n\n    logger?.error(error.message, {\n      code: error.code,\n      correlationId,\n      details: error.details,\n      isOperational: error.isOperational,\n    });\n\n    const response: ApiErrorResponse = {\n      success: false,\n      error: {\n        code: error.code,\n        message: error.userMessage,\n        ...(correlationId && { correlationId }),\n        ...(error.details &&\n          Object.keys(error.details).length > 0 && {\n            details: error.details,\n          }),\n      },\n    };\n\n    if (error instanceof RateLimitError) {\n      response.error.retryAfter = error.retryAfter;\n    }\n\n    const headers: Record<string, string> = {};\n    if (error instanceof RateLimitError) {\n      headers[\"Retry-After\"] = String(error.retryAfter);\n    }\n\n    return NextResponse.json(response, {\n      status: error.statusCode,\n      headers: Object.keys(headers).length > 0 ? headers : undefined,\n    });\n  }\n\n  // Unknown errors — log full details, return generic message\n  const errorMessage = error instanceof Error ? error.message : String(error);\n  const errorStack = error instanceof Error ? error.stack : undefined;\n\n  logger?.error(\"Unhandled error\", {\n    error: errorMessage,\n    stack: errorStack,\n    correlationId,\n    type: (error as { constructor?: { name?: string } })?.constructor?.name,\n  });\n\n  return NextResponse.json(\n    {\n      success: false,\n      error: {\n        code: \"ERR-SYS-001\",\n        message: \"An unexpected error occurred\",\n        ...(correlationId && { correlationId }),\n      },\n    },\n    { status: 500 }\n  );\n}\n\n/**\n * Create a not found response.\n */\nexport function notFoundResponse(\n  resource: string,\n  correlationId?: string\n): NextResponse<ApiErrorResponse> {\n  return NextResponse.json(\n    {\n      success: false,\n      error: {\n        code: \"ERR-DB-003\",\n        message: `${resource} not found`,\n        ...(correlationId && { correlationId }),\n      },\n    },\n    { status: 404 }\n  );\n}\n\n/**\n * Create an unauthorized response.\n */\nexport function unauthorizedResponse(\n  message = \"Authentication required\",\n  correlationId?: string\n): NextResponse<ApiErrorResponse> {\n  return NextResponse.json(\n    {\n      success: false,\n      error: {\n        code: \"ERR-AUTH-001\",\n        message,\n        ...(correlationId && { correlationId }),\n      },\n    },\n    { status: 401 }\n  );\n}\n\n/**\n * Create a forbidden response.\n */\nexport function forbiddenResponse(\n  message = \"Insufficient permissions\",\n  correlationId?: string\n): NextResponse<ApiErrorResponse> {\n  return NextResponse.json(\n    {\n      success: false,\n      error: {\n        code: \"ERR-AUTH-004\",\n        message,\n        ...(correlationId && { correlationId }),\n      },\n    },\n    { status: 403 }\n  );\n}\n\n/**\n * Create a validation error response.\n */\nexport function validationErrorResponse(\n  message: string,\n  details?: Record<string, unknown>,\n  correlationId?: string\n): NextResponse<ApiErrorResponse> {\n  return NextResponse.json(\n    {\n      success: false,\n      error: {\n        code: \"ERR-VAL-001\",\n        message,\n        ...(correlationId && { correlationId }),\n        ...(details && { details }),\n      },\n    },\n    { status: 400 }\n  );\n}\n"],"mappings":"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","names":[]}