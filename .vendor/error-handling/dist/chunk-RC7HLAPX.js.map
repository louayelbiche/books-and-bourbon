{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * @runwell/error-handling — Error Classes\n *\n * Base error classes for standardized error handling.\n * All errors include error codes, HTTP status, and correlation ID support.\n */\n\nexport interface ErrorDetails {\n  field?: string;\n  value?: unknown;\n  [key: string]: unknown;\n}\n\nexport interface AppErrorParams {\n  message: string;\n  code: string;\n  statusCode?: number;\n  isOperational?: boolean;\n  correlationId?: string;\n  details?: ErrorDetails;\n}\n\n/**\n * Base application error class.\n * All custom errors should extend this class.\n */\nexport class AppError extends Error {\n  readonly code: string;\n  readonly statusCode: number;\n  readonly isOperational: boolean;\n  readonly correlationId?: string;\n  readonly details?: ErrorDetails;\n  readonly timestamp: string;\n\n  constructor(params: AppErrorParams) {\n    super(params.message);\n    this.name = this.constructor.name;\n    this.code = params.code;\n    this.statusCode = params.statusCode ?? 500;\n    this.isOperational = params.isOperational ?? true;\n    this.correlationId = params.correlationId;\n    this.details = params.details;\n    this.timestamp = new Date().toISOString();\n\n    if (Error.captureStackTrace) {\n      Error.captureStackTrace(this, this.constructor);\n    }\n  }\n\n  get userMessage(): string {\n    return this.message;\n  }\n\n  toJSON() {\n    return {\n      success: false,\n      error: {\n        code: this.code,\n        message: this.userMessage,\n        ...(this.correlationId && { correlationId: this.correlationId }),\n        ...(this.details &&\n          Object.keys(this.details).length > 0 && { details: this.details }),\n      },\n    };\n  }\n}\n\n/**\n * Authentication error (401).\n */\nexport class AuthenticationError extends AppError {\n  constructor(\n    message = \"Authentication required\",\n    code = \"ERR-AUTH-001\",\n    details?: ErrorDetails\n  ) {\n    super({ message, code, statusCode: 401, details });\n  }\n}\n\n/**\n * Authorization error (403).\n */\nexport class AuthorizationError extends AppError {\n  constructor(\n    message = \"Insufficient permissions\",\n    code = \"ERR-AUTH-004\",\n    details?: ErrorDetails\n  ) {\n    super({ message, code, statusCode: 403, details });\n  }\n}\n\n/**\n * Input validation error (400).\n */\nexport class ValidationError extends AppError {\n  constructor(message: string, details?: ErrorDetails) {\n    super({\n      message,\n      code: \"ERR-VAL-001\",\n      statusCode: 400,\n      details,\n    });\n  }\n}\n\n/**\n * Rate limit error (429).\n */\nexport class RateLimitError extends AppError {\n  readonly retryAfter: number;\n\n  constructor(\n    retryAfter = 60,\n    code = \"ERR-RATE-001\",\n    message = \"Rate limit exceeded\"\n  ) {\n    super({ message, code, statusCode: 429 });\n    this.retryAfter = retryAfter;\n  }\n\n  get userMessage(): string {\n    return `Please wait ${this.retryAfter} seconds before trying again.`;\n  }\n\n  toJSON() {\n    const base = super.toJSON();\n    return {\n      ...base,\n      error: {\n        ...base.error,\n        retryAfter: this.retryAfter,\n      },\n    };\n  }\n}\n\n/**\n * Resource not found error (404).\n */\nexport class NotFoundError extends AppError {\n  readonly resource: string;\n\n  constructor(resource: string) {\n    super({\n      message: `${resource} not found`,\n      code: \"ERR-DB-003\",\n      statusCode: 404,\n    });\n    this.resource = resource;\n  }\n}\n\n/**\n * Duplicate resource error (409).\n */\nexport class DuplicateError extends AppError {\n  constructor(resource: string, details?: ErrorDetails) {\n    super({\n      message: `${resource} already exists`,\n      code: \"ERR-DB-004\",\n      statusCode: 409,\n      details,\n    });\n  }\n}\n\n/**\n * External service error (502).\n */\nexport class ExternalServiceError extends AppError {\n  readonly service: string;\n\n  constructor(service: string, message?: string, code = \"ERR-EXT-001\") {\n    super({\n      message: message ?? `${service} service error`,\n      code,\n      statusCode: 502,\n    });\n    this.service = service;\n  }\n\n  get userMessage(): string {\n    return \"External service temporarily unavailable. Please try again.\";\n  }\n}\n\n/**\n * Default user-facing message map for AI service errors by HTTP status.\n */\nconst DEFAULT_AI_MESSAGE_MAP: Record<number, string> = {\n  429: \"AI rate limit exceeded — please wait a moment and retry.\",\n  401: \"AI API key is invalid or expired.\",\n  403: \"AI API key is invalid or expired.\",\n  400: \"AI request was malformed.\",\n};\n\nexport interface AIServiceErrorOptions {\n  status?: number;\n  detail?: string;\n  messageMap?: Record<number, string>;\n}\n\n/**\n * AI service error (502).\n * Enhanced with GeminiError's userMessage mapping pattern.\n */\nexport class AIServiceError extends AppError {\n  readonly service: string;\n  readonly originalStatus?: number;\n  private readonly _messageMap: Record<number, string>;\n  private readonly _detail?: string;\n\n  constructor(\n    service = \"AI\",\n    message?: string,\n    code = \"ERR-AI-001\",\n    options?: AIServiceErrorOptions\n  ) {\n    const statusCode = options?.status\n      ? options.status >= 500\n        ? options.status\n        : 502\n      : 502;\n    super({\n      message: message ?? `${service} service error`,\n      code,\n      statusCode,\n    });\n    this.service = service;\n    this.originalStatus = options?.status;\n    this._messageMap = { ...DEFAULT_AI_MESSAGE_MAP, ...options?.messageMap };\n    this._detail = options?.detail;\n  }\n\n  get userMessage(): string {\n    if (this.originalStatus && this._messageMap[this.originalStatus]) {\n      return this._messageMap[this.originalStatus];\n    }\n    if (this.message.includes(\"not configured\"))\n      return `${this.service} API key is not configured.`;\n    if (this.message.includes(\"timed out\") || this.message.includes(\"AbortError\"))\n      return `${this.service} request timed out — please retry.`;\n    if (this.message.includes(\"Empty\"))\n      return `${this.service} returned an empty response — please retry.`;\n    return `${this.service} service encountered an error. Please try again.`;\n  }\n}\n\n/**\n * Circuit breaker open error (503).\n */\nexport class CircuitOpenError extends AppError {\n  readonly circuitName: string;\n\n  constructor(circuitName: string) {\n    super({\n      message: `Circuit breaker '${circuitName}' is open`,\n      code: \"ERR-EXT-004\",\n      statusCode: 503,\n    });\n    this.circuitName = circuitName;\n  }\n\n  get userMessage(): string {\n    return \"Service temporarily unavailable. Please try again later.\";\n  }\n}\n\n/**\n * Database error (500).\n */\nexport class DatabaseError extends AppError {\n  constructor(message = \"Database operation failed\", code = \"ERR-DB-002\") {\n    super({\n      message,\n      code,\n      statusCode: 500,\n      isOperational: false,\n    });\n  }\n\n  get userMessage(): string {\n    return \"An error occurred. Please try again.\";\n  }\n}\n\n/**\n * Timeout error (504).\n */\nexport class TimeoutError extends AppError {\n  readonly timeoutMs: number;\n\n  constructor(timeoutMs: number, message?: string) {\n    super({\n      message: message ?? `Operation timed out after ${timeoutMs}ms`,\n      code: \"ERR-SYS-002\",\n      statusCode: 504,\n    });\n    this.timeoutMs = timeoutMs;\n  }\n\n  get userMessage(): string {\n    return \"The request timed out. Please try again.\";\n  }\n}\n\n/**\n * Type guard to check if an error is an AppError.\n */\nexport function isAppError(error: unknown): error is AppError {\n  return error instanceof AppError;\n}\n\n/**\n * Type guard to check if an error is operational (expected).\n */\nexport function isOperationalError(error: unknown): boolean {\n  if (isAppError(error)) {\n    return error.isOperational;\n  }\n  return false;\n}\n"],"mappings":"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","names":[]}