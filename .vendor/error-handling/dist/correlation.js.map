{"version":3,"sources":["../src/correlation.ts"],"sourcesContent":["/**\n * @runwell/error-handling â€” Correlation ID\n *\n * Request tracing via correlation IDs for debugging and log aggregation.\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\n\n/**\n * Header name for correlation ID.\n */\nexport const CORRELATION_ID_HEADER = \"x-correlation-id\";\n\n/**\n * Generate a short unique ID for correlation.\n */\nfunction generateId(): string {\n  return crypto.randomUUID().slice(0, 12);\n}\n\n/**\n * Get or generate a correlation ID from a request.\n */\nexport function getCorrelationId(request: NextRequest): string {\n  return request.headers.get(CORRELATION_ID_HEADER) ?? generateId();\n}\n\n/**\n * Add correlation ID header to a response.\n */\nexport function addCorrelationIdHeader(\n  response: NextResponse,\n  correlationId: string\n): NextResponse {\n  response.headers.set(CORRELATION_ID_HEADER, correlationId);\n  return response;\n}\n\n/**\n * Handler type with correlation ID.\n */\nexport type CorrelationHandler = (\n  request: NextRequest,\n  correlationId: string\n) => Promise<NextResponse>;\n\n/**\n * Higher-order function to wrap API route handlers with correlation ID.\n *\n * Usage:\n * ```typescript\n * export const GET = withCorrelationId(async (req, correlationId) => {\n *   return successResponse(data, { correlationId });\n * });\n * ```\n */\nexport function withCorrelationId(handler: CorrelationHandler) {\n  return async (request: NextRequest): Promise<NextResponse> => {\n    const correlationId = getCorrelationId(request);\n\n    try {\n      const response = await handler(request, correlationId);\n      return addCorrelationIdHeader(response, correlationId);\n    } catch (error) {\n      if (error instanceof Error) {\n        (error as Error & { correlationId?: string }).correlationId =\n          correlationId;\n      }\n      throw error;\n    }\n  };\n}\n\n/**\n * Context type for route handlers that need params.\n */\nexport interface RouteContext {\n  params: Promise<Record<string, string>>;\n}\n\n/**\n * Handler type with correlation ID and route params.\n */\nexport type CorrelationHandlerWithParams = (\n  request: NextRequest,\n  context: RouteContext,\n  correlationId: string\n) => Promise<NextResponse>;\n\n/**\n * Higher-order function for routes with params (e.g., /api/items/[id]).\n *\n * Usage:\n * ```typescript\n * export const GET = withCorrelationIdAndParams(async (req, ctx, correlationId) => {\n *   const { id } = await ctx.params;\n *   return successResponse(data, { correlationId });\n * });\n * ```\n */\nexport function withCorrelationIdAndParams(\n  handler: CorrelationHandlerWithParams\n) {\n  return async (\n    request: NextRequest,\n    context: RouteContext\n  ): Promise<NextResponse> => {\n    const correlationId = getCorrelationId(request);\n\n    try {\n      const response = await handler(request, context, correlationId);\n      return addCorrelationIdHeader(response, correlationId);\n    } catch (error) {\n      if (error instanceof Error) {\n        (error as Error & { correlationId?: string }).correlationId =\n          correlationId;\n      }\n      throw error;\n    }\n  };\n}\n\n/**\n * Create a correlation ID for non-HTTP contexts (e.g., background jobs).\n */\nexport function createCorrelationId(): string {\n  return generateId();\n}\n"],"mappings":";AAWO,IAAM,wBAAwB;AAKrC,SAAS,aAAqB;AAC5B,SAAO,OAAO,WAAW,EAAE,MAAM,GAAG,EAAE;AACxC;AAKO,SAAS,iBAAiB,SAA8B;AAC7D,SAAO,QAAQ,QAAQ,IAAI,qBAAqB,KAAK,WAAW;AAClE;AAKO,SAAS,uBACd,UACA,eACc;AACd,WAAS,QAAQ,IAAI,uBAAuB,aAAa;AACzD,SAAO;AACT;AAoBO,SAAS,kBAAkB,SAA6B;AAC7D,SAAO,OAAO,YAAgD;AAC5D,UAAM,gBAAgB,iBAAiB,OAAO;AAE9C,QAAI;AACF,YAAM,WAAW,MAAM,QAAQ,SAAS,aAAa;AACrD,aAAO,uBAAuB,UAAU,aAAa;AAAA,IACvD,SAAS,OAAO;AACd,UAAI,iBAAiB,OAAO;AAC1B,QAAC,MAA6C,gBAC5C;AAAA,MACJ;AACA,YAAM;AAAA,IACR;AAAA,EACF;AACF;AA6BO,SAAS,2BACd,SACA;AACA,SAAO,OACL,SACA,YAC0B;AAC1B,UAAM,gBAAgB,iBAAiB,OAAO;AAE9C,QAAI;AACF,YAAM,WAAW,MAAM,QAAQ,SAAS,SAAS,aAAa;AAC9D,aAAO,uBAAuB,UAAU,aAAa;AAAA,IACvD,SAAS,OAAO;AACd,UAAI,iBAAiB,OAAO;AAC1B,QAAC,MAA6C,gBAC5C;AAAA,MACJ;AACA,YAAM;AAAA,IACR;AAAA,EACF;AACF;AAKO,SAAS,sBAA8B;AAC5C,SAAO,WAAW;AACpB;","names":[]}