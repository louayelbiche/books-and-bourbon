{"version":3,"sources":["../src/retry.ts"],"sourcesContent":["/**\n * @runwell/error-handling â€” Retry Logic\n *\n * Exponential backoff with jitter for retryable operations.\n * Extracted from agent-core's LLM client.\n */\n\n/**\n * Retry configuration.\n */\nexport interface RetryConfig {\n  maxRetries: number;\n  baseDelayMs: number;\n  maxDelayMs: number;\n}\n\nexport const DEFAULT_RETRY_CONFIG: RetryConfig = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 30000,\n};\n\n/**\n * Check if an error is retryable (429, 503, rate limit, timeout, network errors).\n */\nexport function isRetryableError(error: unknown): boolean {\n  if (error instanceof Error) {\n    const message = error.message.toLowerCase();\n    return (\n      message.includes(\"429\") ||\n      message.includes(\"rate limit\") ||\n      message.includes(\"quota\") ||\n      message.includes(\"too many requests\") ||\n      message.includes(\"503\") ||\n      message.includes(\"service unavailable\") ||\n      message.includes(\"timeout\") ||\n      message.includes(\"econnreset\") ||\n      message.includes(\"network\")\n    );\n  }\n  return false;\n}\n\n/**\n * Calculate backoff delay with jitter.\n */\nexport function calculateBackoff(\n  attempt: number,\n  config: RetryConfig = DEFAULT_RETRY_CONFIG\n): number {\n  const delay = config.baseDelayMs * Math.pow(2, attempt);\n  const jitter = Math.random() * 0.3 * delay; // Up to 30% jitter\n  return Math.min(delay + jitter, config.maxDelayMs);\n}\n\n/**\n * Sleep for a given number of milliseconds.\n */\nexport function sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport interface WithRetryOptions {\n  /** Called before each retry with attempt number, delay, and the error. */\n  onRetry?: (attempt: number, delayMs: number, error: unknown) => void;\n  /** Custom predicate for whether to retry. Defaults to isRetryableError. */\n  shouldRetry?: (error: unknown) => boolean;\n}\n\n/**\n * Higher-order function to retry an async operation with exponential backoff.\n *\n * Usage:\n * ```typescript\n * const result = await withRetry(\n *   () => callExternalApi(data),\n *   { maxRetries: 3 },\n *   { onRetry: (attempt, delay, err) => logger.warn('Retrying', { attempt, delay }) }\n * );\n * ```\n */\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  config: Partial<RetryConfig> = {},\n  options: WithRetryOptions = {}\n): Promise<T> {\n  const retryConfig: RetryConfig = { ...DEFAULT_RETRY_CONFIG, ...config };\n  const shouldRetry = options.shouldRetry ?? isRetryableError;\n\n  let lastError: unknown;\n\n  for (let attempt = 0; attempt <= retryConfig.maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error;\n\n      if (attempt >= retryConfig.maxRetries || !shouldRetry(error)) {\n        throw error;\n      }\n\n      const delayMs = calculateBackoff(attempt, retryConfig);\n      options.onRetry?.(attempt + 1, delayMs, error);\n      await sleep(delayMs);\n    }\n  }\n\n  // Should never reach here, but TypeScript needs it\n  throw lastError;\n}\n"],"mappings":";AAgBO,IAAM,uBAAoC;AAAA,EAC/C,YAAY;AAAA,EACZ,aAAa;AAAA,EACb,YAAY;AACd;AAKO,SAAS,iBAAiB,OAAyB;AACxD,MAAI,iBAAiB,OAAO;AAC1B,UAAM,UAAU,MAAM,QAAQ,YAAY;AAC1C,WACE,QAAQ,SAAS,KAAK,KACtB,QAAQ,SAAS,YAAY,KAC7B,QAAQ,SAAS,OAAO,KACxB,QAAQ,SAAS,mBAAmB,KACpC,QAAQ,SAAS,KAAK,KACtB,QAAQ,SAAS,qBAAqB,KACtC,QAAQ,SAAS,SAAS,KAC1B,QAAQ,SAAS,YAAY,KAC7B,QAAQ,SAAS,SAAS;AAAA,EAE9B;AACA,SAAO;AACT;AAKO,SAAS,iBACd,SACA,SAAsB,sBACd;AACR,QAAM,QAAQ,OAAO,cAAc,KAAK,IAAI,GAAG,OAAO;AACtD,QAAM,SAAS,KAAK,OAAO,IAAI,MAAM;AACrC,SAAO,KAAK,IAAI,QAAQ,QAAQ,OAAO,UAAU;AACnD;AAKO,SAAS,MAAM,IAA2B;AAC/C,SAAO,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,EAAE,CAAC;AACzD;AAqBA,eAAsB,UACpB,IACA,SAA+B,CAAC,GAChC,UAA4B,CAAC,GACjB;AACZ,QAAM,cAA2B,EAAE,GAAG,sBAAsB,GAAG,OAAO;AACtE,QAAM,cAAc,QAAQ,eAAe;AAE3C,MAAI;AAEJ,WAAS,UAAU,GAAG,WAAW,YAAY,YAAY,WAAW;AAClE,QAAI;AACF,aAAO,MAAM,GAAG;AAAA,IAClB,SAAS,OAAO;AACd,kBAAY;AAEZ,UAAI,WAAW,YAAY,cAAc,CAAC,YAAY,KAAK,GAAG;AAC5D,cAAM;AAAA,MACR;AAEA,YAAM,UAAU,iBAAiB,SAAS,WAAW;AACrD,cAAQ,UAAU,UAAU,GAAG,SAAS,KAAK;AAC7C,YAAM,MAAM,OAAO;AAAA,IACrB;AAAA,EACF;AAGA,QAAM;AACR;","names":[]}