{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { readFileSync, writeFileSync, mkdirSync, renameSync } from 'fs';\nimport { join } from 'path';\n\nconst SNAPSHOT_DIR = join(process.cwd(), 'cms-snapshots');\ntry { mkdirSync(SNAPSHOT_DIR, { recursive: true }); } catch {}\n\nexport function saveSnapshot<T>(key: string, data: T): void {\n  try {\n    const path = join(SNAPSHOT_DIR, `${key}.json`);\n    const tmp = path + '.tmp';\n    writeFileSync(tmp, JSON.stringify(data));\n    renameSync(tmp, path); // atomic write\n  } catch (error) {\n    console.error(`[cms-snapshot] Failed to save ${key}:`, error);\n  }\n}\n\nexport function loadSnapshot<T>(key: string): T | null {\n  try {\n    const path = join(SNAPSHOT_DIR, `${key}.json`);\n    return JSON.parse(readFileSync(path, 'utf-8')) as T;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Stale-while-revalidate helper.\n * Returns snapshot instantly if available (refreshes in background),\n * otherwise awaits the fetcher and saves the result.\n */\nexport async function snapshotFirst<T>(\n  key: string,\n  fetcher: () => Promise<T | null>,\n): Promise<T | null> {\n  const snapshot = loadSnapshot<T>(key);\n  if (snapshot) {\n    void fetcher().then(result => {\n      if (result !== null) saveSnapshot(key, result);\n    }).catch(() => {});\n    return snapshot;\n  }\n  const result = await fetcher();\n  if (result !== null) {\n    saveSnapshot(key, result);\n    return result;\n  }\n  return null;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAAmE;AACnE,kBAAqB;AAErB,IAAM,mBAAe,kBAAK,QAAQ,IAAI,GAAG,eAAe;AACxD,IAAI;AAAE,2BAAU,cAAc,EAAE,WAAW,KAAK,CAAC;AAAG,QAAQ;AAAC;AAEtD,SAAS,aAAgB,KAAa,MAAe;AAC1D,MAAI;AACF,UAAM,WAAO,kBAAK,cAAc,GAAG,GAAG,OAAO;AAC7C,UAAM,MAAM,OAAO;AACnB,iCAAc,KAAK,KAAK,UAAU,IAAI,CAAC;AACvC,8BAAW,KAAK,IAAI;AAAA,EACtB,SAAS,OAAO;AACd,YAAQ,MAAM,iCAAiC,GAAG,KAAK,KAAK;AAAA,EAC9D;AACF;AAEO,SAAS,aAAgB,KAAuB;AACrD,MAAI;AACF,UAAM,WAAO,kBAAK,cAAc,GAAG,GAAG,OAAO;AAC7C,WAAO,KAAK,UAAM,wBAAa,MAAM,OAAO,CAAC;AAAA,EAC/C,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAOA,eAAsB,cACpB,KACA,SACmB;AACnB,QAAM,WAAW,aAAgB,GAAG;AACpC,MAAI,UAAU;AACZ,SAAK,QAAQ,EAAE,KAAK,CAAAA,YAAU;AAC5B,UAAIA,YAAW,KAAM,cAAa,KAAKA,OAAM;AAAA,IAC/C,CAAC,EAAE,MAAM,MAAM;AAAA,IAAC,CAAC;AACjB,WAAO;AAAA,EACT;AACA,QAAM,SAAS,MAAM,QAAQ;AAC7B,MAAI,WAAW,MAAM;AACnB,iBAAa,KAAK,MAAM;AACxB,WAAO;AAAA,EACT;AACA,SAAO;AACT;","names":["result"]}